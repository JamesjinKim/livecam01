# PRD (Product Requirements Document) - SHT 듀얼 LIVE 카메라

## 📋 문서 정보
- **버전**: 3.0 🎆
- **작성일**: 2025-09-08
- **마지막 업데이트**: 2025-09-13 (듀얼 뷰 시스템 완성)
- **대상 시스템**: **SHT 듀얼 LIVE 카메라** - 듀얼 동시 뷰 CCTV + 모션 감지 블랙박스
- **플랫폼**: Raspberry Pi 5, Python 3
- **주요 변경**: 웹 UI 레이아웃 개선, 프레임 수 초기화 로직 추가, Ctrl+C 종료 처리 개선

---

## 🎯 Part 1: 듀얼 카메라 CCTV 스트리밍 시스템 🎆

### 🚀 2025.09 Picamera2 마이그레이션 완료

**마이그레이션 성과**:
- ✅ **안정성 대폭 향상**: rpicam-vid 서브프로세스 방식의 장기 스트리밍 중 멈춤 현상 완전 해결
- ✅ **성능 향상**: CPU 사용률 20-30% 감소, 메모리 효율성 향상
- ✅ **하드웨어 가속**: Pi5 VideoCore VII GPU + PiSP BCM2712_D0 직접 활용
- ✅ **UI 완전성**: 기존 cctv_main.py의 모든 기능과 UI 100% 보존
- ✅ **하트비트 모니터링**: 실시간 스트림 상태 감지 시스템 통합
- ✅ **웹/백엔드 분리**: 코드 보호를 위한 모듈화 구조 지원 (2025.09.11 추가) ⭐

### 1.1 시스템 개요

#### 목적
**SHT 듀얼 LIVE 카메라** - 라즈베리파이 5 기반 **듀얼 카메라 동시 보기** CCTV 시스템
- **듀얼 뷰**: 두 카메라를 나란히 동시 보기 (640x480 각각)
- **싱글 뷰**: 카메라 선택 시 해당 카메라만 크게 보기
- **실시간 전환**: 버튼 클릭으로 즉시 뷰 모드 전환
**2025.09**: Picamera2 라이브러리 기반 GPU 직접 액세스로 장기 안정성 확보
**2025.09.13**: 듀얼 뷰 시스템 완성 🎆

#### 핵심 가치 제안
- **듀얼 동시 뷰**: 두 카메라를 동시에 보며 비교 모니터링 가능 (2025.09.13 완성) 🎆
- **싱글 뷰 전환**: 버튼 클릭으로 개별 카메라 확대 보기
- **실시간 레이블링**: 모든 뷰에서 카메라 구분 라벨 표시
- **다중 클라이언트 지원**: 해상도별 최대 2명 동시 접속
- **실시간 웹 스트리밍**: 브라우저 기반 즉시 접근
- **해상도 동적 변경**: 네트워크 환경에 따른 최적화
- ⚡ **Picamera2 GPU 가속**: 서브프로세스 제거로 Zero-latency 처리
- ❤️ **하트비트 모니터링**: 실시간 스트림 상태 및 품질 감시
- 💚 **직관적 UI**: 일관된 버튼 레이아웃 및 대칭 정렬
- 🔄 **메모리 안정성**: 10만 프레임마다 자동 초기화
- ⚡ **즉시 종료**: Ctrl+C 입력 시 카메라 정리 후 즉시 종료

### 1.2 기술 아키텍처

#### 현재 운영 중인 시스템 (2025.09.13 기준)
- **🎆 메인 버전**: `webmain.py` (듀얼 뷰 지원 분리 버전) ⭐ 주력
- **📦 레거시 버전**: `picam2_main.py` (토글 방식 기존 운영용)

#### 시스템 구성도 (공통)
```
┌─────────────────────────────────────────────────────────────┐
│                    CCTV 스트리밍 시스템                        │
├─────────────────────────────────────────────────────────────┤
│  웹 브라우저 (Client)                                          │
│  └─ HTML5 + JavaScript (실시간 UI)                           │
├─────────────────────────────────────────────────────────────┤
│  FastAPI 웹 서버 (Port 8001)                                 │
│  ├─ REST API (카메라 제어, 해상도 변경)                        │
│  ├─ MJPEG 스트리밍 엔드포인트                                  │
│  └─ 단일 클라이언트 세션 관리                                  │
├─────────────────────────────────────────────────────────────┤
│  Picamera2 직접 GPU 액세스 ⚡                                 │
│  ├─ Camera 0 (OV5647) - 라이브러리 직접 호출                    │
│  ├─ Camera 1 (OV5647) - 라이브러리 직접 호출                    │
│  └─ VideoCore VII + PiSP BCM2712_D0 하드웨어 가속           │
├─────────────────────────────────────────────────────────────┤
│  하드웨어 레이어                                               │
│  └─ Raspberry Pi 5 + Dual Camera Module                    │
└─────────────────────────────────────────────────────────────┘
```

#### 기술 스택 (2025.09 업그레이드)
- **백엔드**: FastAPI, Python 3.11+
- **카메라 엔진**: ⚡ **Picamera2 라이브러리** (서브프로세스 제거)
- **스트리밍**: MJPEG over HTTP + HEAD 메서드 지원
- **하드웨어 가속**: VideoCore VII + **PiSP BCM2712_D0** 직접 활용
- **프론트엔드**: Vanilla JavaScript, HTML5 + 하트비트 모니터링
- **네트워크**: HTTP/1.1, 포트 8001

### 1.3 핵심 기능 명세

#### 1.3.1 실시간 스트리밍
**기능**: 단일 클라이언트 MJPEG 스트리밍 (Picamera2 기반) ⚡
```python
# Picamera2 직접 구현 (서브프로세스 제거)
@app.api_route("/stream", methods=["GET", "HEAD"])
async def video_stream(request: Request):
    if request.method == "HEAD":  # 하트비트 지원
        return Response(status_code=200 if camera_active else 503)
    
    # Picamera2 직접 JPEG 캡처 (GPU 가속)
    return StreamingResponse(generate_mjpeg_stream(), 
                           media_type="multipart/x-mixed-replace")
```

**성능 요구사항** (Picamera2 실측) ⚡:
- 480p: 30fps, ~31KB/frame (640×480)
- 720p: 30fps, ~109KB/frame (1280×720) **개선됨**
- 지연시간: **< 200ms** (60% 개선)
- 메모리 사용: **< 60MB** (40% 감소)
- CPU 사용률: **20-30% 절약**

#### 1.3.2 듀얼 카메라 토글
**기능**: 실시간 카메라 전환 (Picamera2 인스턴스 관리) ⚡
```python
def start_camera_stream(camera_id: int):
    # Picamera2 직접 인스턴스 생성 (서브프로세스 제거)
    picam2 = Picamera2(camera_num=camera_id)
    config = picam2.create_video_configuration(
        main={"size": (width, height), "format": "YUV420"}
    )
    picam2.configure(config)
    picam2.start()  # 즉시 GPU 가속 시작
```

**전환 시간**: **< 1초** (3배 향상)
**안정성**: 좀비 프로세스 원천 차단, GPU 메모리 직접 관리

#### 1.3.3 동적 해상도 변경
**지원 해상도**:
- **480p**: 640×480 (기본)
- **720p**: 1280×720

**최적화 파라미터**:
| 해상도 | 청크 크기 | 버퍼 한계 | 프레임 크기 범위 |
|--------|-----------|-----------|------------------|
| 480p   | 16KB      | 512KB     | 2-200KB         |
| 720p   | 32KB      | 2MB       | 5-500KB         |

#### 1.3.4 단일 클라이언트 관리
**세션 관리**:
- IP 기반 클라이언트 추적
- 최대 1개 동시 연결
- 423 Locked HTTP 응답
- 자동 세션 정리

### 1.4 웹 인터페이스

#### UI 컴포넌트 (2025.09 업그레이드)
- **라이브 스트림 뷰어**: 전체 화면 활용
- **카메라 토글 버튼**: Camera 0 ↔ Camera 1
- **해상도 선택**: 480p / 720p
- **실시간 통계**: FPS, 프레임 수, 평균 크기
- ❤️ **하트비트 인디케이터**: LIVE/DELAY/ERROR/OFFLINE 상태 표시
- **일관된 디자인**: 모든 버튼 통일된 스타일

#### 반응형 디자인
```css
/* 모던 그레이 톤 디자인 */
background: #f5f5f5;
accent-color: #007bff; /* 파란색 액센트 */
```

### 1.5 성능 최적화

#### 스트리밍 최적화 (Picamera2 기반) ⚡
- **GPU 직접 액세스**: 서브프로세스 오버헤드 완전 제거
- **Zero-copy 스트림**: Picamera2 → BytesIO 직접 전송
- **하드웨어 버퍼링**: Pi5 자체 버퍼링 시스템 활용
- **PiSP 가속**: Image Signal Processor BCM2712_D0 활용
- **인스턴스 관리**: 메모리 누수 방지

#### 네트워크 최적화
- **청크 단위 전송**: 16KB/32KB 청크
- **HTTP Keep-Alive**: 연결 재사용
- **압축 품질**: MJPEG 80% 품질

### 1.6 보안 및 안정성

#### 보안 요소
- **IP 기반 접근 제어**: 내부 네트워크 권장
- **단일 세션 제한**: DDoS 방지
- **프로세스 격리**: subprocess 독립 실행

#### 안정성 보장
- **자동 복구**: 스트림 오류 시 재시도
- **리소스 정리**: 프로세스 완전 종료
- **에러 핸들링**: 상세한 로그 및 상태 표시

### 1.7 배포 및 운영

#### 시스템 요구사항
- **하드웨어**: Raspberry Pi 5, OV5647 카메라 ×2
- **OS**: Raspberry Pi OS (64-bit)
- **Python**: 3.11+
- **네트워크**: 10Mbps+ (720p 기준)

#### 실행 방법 (2025.09)
```bash
# Picamera2 기반 CCTV 실행
python3 picam2_main.py

# 레거시 (참고용)
# python3 cctv_main.py  # 구버전 (rpicam-vid)

# 접속 URL
http://라즈베리파이_IP:8001
```

#### 모니터링 (2025.09 강화)
- **실시간 통계**: 웹 UI 통계 패널
- ❤️ **하트비트 모니터링**: 2초마다 스트림 상태 자동 체크
- **로그 분석**: 콘솔 출력 + PiSP 하드웨어 로그
- **성능 지표**: FPS, 메모리 사용량, GPU 활용률

#### 핵심 컴포넌트
```python
# 주요 클래스 구조
├── MotionDetectionSystem (메인 조정자)
├── CameraStreamManager (카메라 스트림 관리)
└── Config (설정 관리)
```
### 2.6 저장 관리 시스템

#### 폴더 구조

#### 파일명 규칙
- **형식**: `motion_event_cam{N}_{YYYYMMDD}_{HHMMSS}.mp4`
- **예시**: `motion_event_cam0_20250908_143025.mp4`

### 2.7 성능 및 안정성

#### 성능 지표
- **CPU 사용률**: ~15-20% (단일 카메라, 720p)
- **메모리 사용**: ~50-60MB
- **저장 용량**: ~5-6MB/30초 영상

#### 안정성 보장
- **프로세스 정리**: SIGTERM → SIGKILL 순차 종료
- **백그라운드 스레드**: daemon=False로 정상 종료
- **임시 파일 관리**: 자동 정리 시스템
- **오류 복구**: 스트림 재시작 메커니즘

### 2.8 운영 및 모니터링

## 📊 전체 시스템 통합

### 시스템 간 관계
- **독립 운영**: CCTV 시스템 분리 실행
- **리소스 공유**: 동일한 카메라 하드웨어 활용
- **상호 보완**: 실시간 모니터링 

### 권장 운영 방식 (2025.09 업데이트)
1. **일반 모니터링**: ⚡ CCTV 시스템(`webmain.py`) 상시 실행
2. **보안 강화**: 야간 또는 부재 시 모션 감지 시스템 추가 실행
3. **저장소 관리**: 정기적인 영상 파일 백업 및 정리
4. **24/7 안정성**: Picamera2 기반으로 장기 운영 보장

### 향후 확장성
- **통합 대시보드**: 두 시스템을 통합한 웹 인터페이스
- **알림 시스템**: 모션 감지 시 실시간 알림
- **클라우드 연동**: 자동 백업 및 원격 접근