# PRD (Product Requirements Document) - SHT 듀얼 LIVE 카메라

## 문서 정보
- **버전**: 3.1
- **마지막 업데이트**: 2025-09-15
- **대상 시스템**: **SHT 듀얼 LIVE 카메라** - 듀얼 동시 뷰 CCTV + 30초 연속 녹화 시스템
- **플랫폼**: Raspberry Pi 5, Python 3.11+

---

## Part 1: 듀얼 카메라 CCTV 스트리밍 시스템

### 1.1 시스템 개요

#### 목적
라즈베리파이 5 기반 듀얼 카메라 동시 보기 CCTV 시스템
- **듀얼 뷰**: 두 카메라를 나란히 동시 보기 (640x480 각각)
- **싱글 뷰**: 카메라 선택 시 해당 카메라만 크게 보기
- **실시간 전환**: 버튼 클릭으로 즉시 뷰 모드 전환

#### 핵심 가치 제안
- **듀얼 동시 뷰**: 두 카메라를 동시에 보며 비교 모니터링 가능
- **싱글 뷰 전환**: 버튼 클릭으로 개별 카메라 확대 보기
- **실시간 레이블링**: 모든 뷰에서 카메라 구분 라벨 표시
- **다중 클라이언트 지원**: 해상도별 최대 2명 동시 접속
- **실시간 웹 스트리밍**: 브라우저 기반 즉시 접근
- **해상도 동적 변경**: 네트워크 환경에 따른 최적화
- **Picamera2 GPU 가속**: 서브프로세스 제거로 Zero-latency 처리
- **하트비트 모니터링**: 실시간 스트림 상태 및 품질 감시
- **직관적 UI**: 일관된 버튼 레이아웃 및 대칭 정렬
- **메모리 안정성**: 10만 프레임마다 자동 초기화
- **즉시 종료**: Ctrl+C 입력 시 카메라 정리 후 즉시 종료

### 1.2 기술 아키텍처

#### 현재 운영 중인 시스템
- **메인 버전**: `webmain.py` (듀얼 뷰 지원 웹/백엔드 분리 버전)
- **30초 녹화 시스템**: `rec_cam0.py`, `rec_cam1.py` (연속 녹화)

#### 시스템 구성도
```
┌─────────────────────────────────────────────────────────────┐
│                    CCTV 스트리밍 시스템                        │
├─────────────────────────────────────────────────────────────┤
│  웹 브라우저 (Client)                                          │
│  └─ HTML5 + JavaScript (실시간 UI)                           │
├─────────────────────────────────────────────────────────────┤
│  FastAPI 웹 서버 (Port 8001)                                 │
│  ├─ REST API (카메라 제어, 해상도 변경)                        │
│  ├─ MJPEG 스트리밍 엔드포인트                                  │
│  └─ 다중 클라이언트 세션 관리                                  │
├─────────────────────────────────────────────────────────────┤
│  Picamera2 직접 GPU 액세스                                    │
│  ├─ Camera 0 (OV5647) - 라이브러리 직접 호출                    │
│  ├─ Camera 1 (OV5647) - 라이브러리 직접 호출                    │
│  └─ VideoCore VII + PiSP BCM2712_D0 하드웨어 가속           │
├─────────────────────────────────────────────────────────────┤
│  하드웨어 레이어                                               │
│  └─ Raspberry Pi 5 + Dual Camera Module                    │
└─────────────────────────────────────────────────────────────┘
```

#### 기술 스택
- **백엔드**: FastAPI, Python 3.11+
- **카메라 엔진**: Picamera2 라이브러리 (GPU 직접 액세스)
- **스트리밍**: MJPEG over HTTP + HEAD 메서드 지원
- **하드웨어 가속**: VideoCore VII + PiSP BCM2712_D0
- **프론트엔드**: Vanilla JavaScript, HTML5 + 하트비트 모니터링
- **네트워크**: HTTP/1.1, 포트 8001

### 1.3 핵심 기능 명세

#### 1.3.1 실시간 스트리밍
**기능**: 다중 클라이언트 MJPEG 스트리밍 (Picamera2 기반)
```python
# Picamera2 직접 구현 (서브프로세스 제거)
@app.api_route("/stream", methods=["GET", "HEAD"])
async def video_stream(request: Request):
    if request.method == "HEAD":  # 하트비트 지원
        return Response(status_code=200 if camera_active else 503)

    # Picamera2 직접 JPEG 캡처 (GPU 가속)
    return StreamingResponse(generate_mjpeg_stream(),
                           media_type="multipart/x-mixed-replace")
```

**성능 요구사항** (Picamera2 실측):
- 480p: 30fps, ~31KB/frame (640×480)
- 720p: 30fps, ~109KB/frame (1280×720)
- 지연시간: < 200ms
- 메모리 사용: < 60MB
- CPU 사용률: ~7-11%

#### 1.3.2 듀얼 카메라 관리
**기능**: 듀얼 뷰/싱글 뷰 전환 (Picamera2 인스턴스 관리)
```python
def start_camera_stream(camera_id: int):
    # Picamera2 직접 인스턴스 생성 (서브프로세스 제거)
    picam2 = Picamera2(camera_num=camera_id)
    config = picam2.create_video_configuration(
        main={"size": (width, height), "format": "YUV420"}
    )
    picam2.configure(config)
    picam2.start()  # 즉시 GPU 가속 시작
```

**전환 시간**: < 1초
**안정성**: GPU 메모리 직접 관리, 리소스 자동 정리

#### 1.3.3 동적 해상도 변경
**지원 해상도**:
- **480p**: 640×480 (기본)
- **720p**: 1280×720

**최적화 파라미터**:
| 해상도 | 청크 크기 | 버퍼 한계 | 프레임 크기 범위 |
|--------|-----------|-----------|------------------|
| 480p   | 16KB      | 512KB     | 2-200KB         |
| 720p   | 32KB      | 2MB       | 5-500KB         |

#### 1.3.4 다중 클라이언트 관리
**세션 관리**:
- IP 기반 클라이언트 추적
- 최대 2개 동시 연결
- 423 Locked HTTP 응답 (제한 초과 시)
- 자동 세션 정리

### 1.4 웹 인터페이스

#### UI 컴포넌트
- **라이브 스트림 뷰어**: 듀얼/싱글 뷰 모드
- **카메라 전환 버튼**: Dual View, Camera 0, Camera 1
- **해상도 선택**: 480p / 720p
- **실시간 통계**: FPS, 프레임 수, 평균 크기
- **하트비트 인디케이터**: LIVE/DELAY/ERROR/OFFLINE 상태 표시
- **일관된 디자인**: 모든 버튼 통일된 스타일

#### 반응형 디자인
```css
/* 모던 그레이 톤 디자인 */
background: #f5f5f5;
accent-color: #007bff; /* 파란색 액센트 */
```

### 1.5 성능 최적화

#### 스트리밍 최적화 (Picamera2 기반)
- **GPU 직접 액세스**: 서브프로세스 오버헤드 제거
- **Zero-copy 스트림**: Picamera2 → BytesIO 직접 전송
- **하드웨어 버퍼링**: Pi5 자체 버퍼링 시스템 활용
- **PiSP 가속**: Image Signal Processor BCM2712_D0 활용
- **인스턴스 관리**: 메모리 누수 방지

#### 네트워크 최적화
- **청크 단위 전송**: 16KB/32KB 청크
- **HTTP Keep-Alive**: 연결 재사용
- **압축 품질**: MJPEG 80% 품질

### 1.6 보안 및 안정성

#### 보안 요소
- **IP 기반 접근 제어**: 내부 네트워크 권장
- **세션 제한**: DDoS 방지
- **프로세스 격리**: subprocess 독립 실행

#### 안정성 보장
- **자동 복구**: 스트림 오류 시 재시도
- **리소스 정리**: 프로세스 완전 종료
- **에러 핸들링**: 상세한 로그 및 상태 표시

### 1.7 배포 및 운영

#### 시스템 요구사항
- **하드웨어**: Raspberry Pi 5, OV5647 카메라 ×2
- **OS**: Raspberry Pi OS (64-bit)
- **Python**: 3.11+
- **네트워크**: 10Mbps+ (720p 기준)

#### 실행 방법
```bash
# 듀얼 뷰 CCTV 실행
python3 webmain.py

# 30초 연속 녹화 실행
python3 rec_cam0.py  # 카메라 0
python3 rec_cam1.py  # 카메라 1

# 접속 URL
http://라즈베리파이_IP:8001
```

#### 모니터링
- **실시간 통계**: 웹 UI 통계 패널
- **하트비트 모니터링**: 2초마다 스트림 상태 자동 체크
- **로그 분석**: 콘솔 출력 + PiSP 하드웨어 로그
- **성능 지표**: FPS, 메모리 사용량, GPU 활용률

---

## Part 2: 30초 연속 녹화 시스템

### 2.1 시스템 개요

#### 목적
라즈베리파이 5 기반 듀얼 카메라 30초 단위 연속 녹화 시스템
- **연속 녹화**: 24시간 30초 단위로 끊김없이 녹화
- **듀얼 카메라**: 카메라 0, 1 독립적으로 동시 녹화
- **자동 파일 관리**: 날짜별 폴더 자동 생성 및 정리

#### 기술 스택
- **녹화 엔진**: rpicam-vid (H.264 하드웨어 인코딩)
- **파일 관리**: Python subprocess + 자동 파일명 생성
- **저장 구조**: videos/cam_rec/cam{0,1}/YYMMDD/

### 2.2 핵심 기능 명세

#### 2.2.1 연속 녹화
**기능**: 30초 단위 무한 루프 녹화
- 파일명: cam{N}_YYYYMMDD_HHMMSS.mp4
- 해상도: 1280×720 (720p)
- 프레임레이트: 30fps
- 코덱: H.264 하드웨어 인코딩

#### 2.2.2 파일 관리
**자동 관리 기능**:
- 날짜 변경 시 새 폴더 자동 생성
- 파일명에 타임스탬프 포함
- 디스크 공간 체크 (여유 공간 < 1GB 시 경고)

### 2.3 저장 관리 시스템

#### 폴더 구조
```
videos/
└── cam_rec/           # 30초 연속 녹화 저장소
    ├── cam0/
    │   ├── 250915/    # YYMMDD 날짜별 폴더
    │   └── 250916/
    └── cam1/
        ├── 250915/
        └── 250916/
```

#### 파일명 규칙
- **형식**: `cam{N}_{YYYYMMDD}_{HHMMSS}.mp4`
- **예시**: `cam0_20250915_143025.mp4`

### 2.4 성능 및 안정성

#### 성능 지표
- **CPU 사용률**: ~8-10% (단일 카메라, 720p)
- **메모리 사용**: ~30-40MB
- **저장 용량**: ~6-8MB/30초 영상 (720p)

#### 안정성 보장
- **프로세스 관리**: subprocess 자동 재시작
- **오류 복구**: 녹화 실패 시 자동 재시도
- **디스크 관리**: 공간 부족 경고 시스템
- **파일 무결성**: 30초 정확한 길이 보장

### 2.5 운영 및 모니터링

#### 실행 방법
```bash
# 카메라 0 녹화 시작
python3 rec_cam0.py

# 카메라 1 녹화 시작 (별도 터미널)
python3 rec_cam1.py
```

#### 종료 방법
- Ctrl+C로 안전하게 종료
- 현재 녹화 중인 파일 자동 저장

---

## 전체 시스템 통합

### 시스템 간 관계
- **독립 운영**: CCTV와 녹화 시스템 별도 실행 가능
- **동시 운영**: 카메라 리소스 충돌 없이 동시 사용
- **상호 보완**: 실시간 모니터링 + 연속 녹화

### 권장 운영 방식
1. **실시간 모니터링**: CCTV 시스템(`webmain.py`) 상시 실행
2. **연속 녹화**: 30초 녹화 시스템(`rec_cam0.py`, `rec_cam1.py`) 동시 실행
3. **저장소 관리**: 정기적인 영상 파일 백업 및 정리
4. **24/7 안정성**: Picamera2 + rpicam-vid 조합으로 장기 운영 보장

### 향후 확장성
- **통합 대시보드**: CCTV + 녹화 통합 관리 인터페이스
- **모션 감지 추가**: 이벤트 기반 녹화 시스템
- **클라우드 연동**: 자동 백업 및 원격 접근
- **AI 분석**: 녹화된 영상 자동 분석 및 이벤트 감지