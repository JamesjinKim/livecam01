# CLAUDE.md - ê°œë°œì ê¸°ìˆ  ë¬¸ì„œ

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”

**SHT ë“€ì–¼ LIVE ì¹´ë©”ë¼** - ë¼ì¦ˆë² ë¦¬íŒŒì´ 5 ê¸°ë°˜ í†µí•© CCTV ë° ëª¨ì…˜ ê°ì§€ ë¸”ë™ë°•ìŠ¤ ì‹œìŠ¤í…œ
- **ëª©ì **: ì‹¤ì‹œê°„ CCTV ìŠ¤íŠ¸ë¦¬ë° + ì§€ëŠ¥í˜• ëª¨ì…˜ ê°ì§€ ë¸”ë™ë°•ìŠ¤
- **í•µì‹¬**: FastAPI ì›¹ ì„œë²„ + OpenCV ëª¨ì…˜ ê°ì§€ + Picamera2 GPU ê°€ì† ì¸ì½”ë”© âš¡
- **íŠ¹ì§•**: ë‹¤ì¤‘ í´ë¼ì´ì–¸íŠ¸ CCTV (ìµœëŒ€ 2ëª…), í”„ë¦¬ë²„í¼ ë¸”ë™ë°•ìŠ¤, ë‚ ì§œë³„ ìë™ ë¶„ë¥˜
- **2025ë…„ 9ì›”**: **rpicam-vid â†’ Picamera2 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ** (ì•ˆì •ì„± ëŒ€í­ í–¥ìƒ)

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ê¸°ìˆ  ìŠ¤íƒ
- **í•˜ë“œì›¨ì–´**: Raspberry Pi 5 (BCM2712), OV5647 ì¹´ë©”ë¼ ëª¨ë“ˆ Ã— 2
- **CCTV**: FastAPI + MJPEG ìŠ¤íŠ¸ë¦¬ë° (ìµœëŒ€ 2ëª… ë™ì‹œ ì ‘ì†)
- **ëª¨ì…˜ ê°ì§€**: OpenCV BackgroundSubtractorMOG2
- **ì˜ìƒ ì²˜ë¦¬**: âš¡ **Picamera2 ë¼ì´ë¸ŒëŸ¬ë¦¬ + VideoCore VII GPU ì§ì ‘ ì•¡ì„¸ìŠ¤** (2025.09 ì—…ê·¸ë ˆì´ë“œ)
- **í”„ë¡ íŠ¸ì—”ë“œ**: Vanilla JavaScript, ë°˜ì‘í˜• ì›¹ UI + ì‹¤ì‹œê°„ í•˜íŠ¸ë¹„íŠ¸ ëª¨ë‹ˆí„°ë§

### ì‹œìŠ¤í…œ êµ¬ì„±

```
livecam/
â”œâ”€â”€ webmain.py             # ğŸ”´ ë©”ì¸ CCTV ì„œë²„ (Picamera2 ê¸°ë°˜) âš¡ í˜„ì¬ ìš´ì˜ì¤‘
â”œâ”€â”€ cctv_main.py               # ğŸ”´ êµ¬ë²„ì „ 
ê°ì§€ ë¸”ë™ë°•ìŠ¤  
â”œâ”€â”€ detection_cam0.py           # âš« ì¹´ë©”ë¼ 0 ëª¨ì…˜ 
â”œâ”€â”€ detection_cam1.py           # âš« ì¹´ë©”ë¼ 1 ëª¨ì…˜ ê°ì§€ ë¸”ë™ë°•ìŠ¤
â”œâ”€â”€ rec_cam0.py                 # ğŸ§ª ì¹´ë©”ë¼ 0 ë…¹í™” 30ì´ˆ ê¸°ëŠ¥
â”œâ”€â”€ rec_cam1.py                 # ğŸ§ª ì¹´ë©”ë¼ 1 ë…¹í™” 30ì´ˆ ê¸°ëŠ¥
â”œâ”€â”€ PRD.md                      # ğŸ“‹ ì œí’ˆ ìš”êµ¬ì‚¬í•­ ë¬¸ì„œ
â”œâ”€â”€ README.md                   # ğŸ“– ì‚¬ìš©ì ê°€ì´ë“œ
â”œâ”€â”€ CLAUDE.md                   # ğŸ”§ ê°œë°œì ê¸°ìˆ  ë¬¸ì„œ (í˜„ì¬ íŒŒì¼)
â””â”€â”€ videos/                     # ì˜ìƒ ì €ì¥ì†Œ
    â””â”€â”€ cam_rec/                # ì˜ìƒ 30ì´ˆ ë‹¨ìœ„ ì €ì¥
        â”œâ”€â”€ cam0/
        â”‚   â”œâ”€â”€ 250908/         # YYMMDD ë‚ ì§œë³„ í´ë”
        â”‚   â””â”€â”€ 250909/
        â””â”€â”€ cam1/
            â”œâ”€â”€ 250908/
            â””â”€â”€ 250909/

    â””â”€â”€ motion_events/          # ëª¨ì…˜ ê°ì§€ ì´ë²¤íŠ¸ ì €ì¥
        â”œâ”€â”€ cam0/
        â”‚   â”œâ”€â”€ 250908/         # YYMMDD ë‚ ì§œë³„ í´ë”
        â”‚   â””â”€â”€ 250909/
        â””â”€â”€ cam1/
            â”œâ”€â”€ 250908/
            â””â”€â”€ 250909/
```

---
## Python code ë‚´ì—ì„œ ì´ëª¨ì§€ ì‚¬ìš© ê¸ˆì§€!

## ğŸ”´ Part 1: CCTV ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‹œìŠ¤í…œ

### ğŸš€ 2025ë…„ 9ì›” Picamera2 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ

**ë§ˆì´ê·¸ë ˆì´ì…˜ ë°°ê²½**:
- rpicam-vid ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ë°©ì‹ì˜ ì¥ê¸° ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ë©ˆì¶¤ í˜„ìƒ í•´ê²°
- "Pipeline handler in use by another process" ì—ëŸ¬ ê·¼ë³¸ í•´ê²°
- Pi5 VideoCore VII GPU ì§ì ‘ ì•¡ì„¸ìŠ¤ë¡œ ì„±ëŠ¥ í–¥ìƒ

**í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ì‹œìŠ¤í…œ** (2025.09.11 ê¸°ì¤€):
- âœ… **webmain.py**: ì›¹ ë“€ì–¼ live camera ë²„ì „

**ì£¼ìš” ê°œì„ ì‚¬í•­**:
- âœ… ì„œë¸Œí”„ë¡œì„¸ìŠ¤ â†’ ì§ì ‘ ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œë¡œ ì•ˆì •ì„± ëŒ€í­ í–¥ìƒ
- âœ… ê¸°ì¡´ cctv_main.py UI/UX 100% ë³´ì¡´
- âœ… í•˜íŠ¸ë¹„íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì™„ì „ í†µí•©
- âœ… Pi5 PiSP BCM2712_D0 í•˜ë“œì›¨ì–´ ê°€ì† í™œìš©
- âœ… **ì›¹/ë°±ì—”ë“œ ë¶„ë¦¬ êµ¬ì¡° ì§€ì›** (2025.09.11 ì¶”ê°€)

### ğŸ“… 2025ë…„ 9ì›” 13ì¼ ë“€ì–¼ ë·° ì‹œìŠ¤í…œ ì™„ì„± ğŸ‰

**ë“€ì–¼ ì¹´ë©”ë¼ ë™ì‹œ ë·° ì‹œìŠ¤í…œ (2025.09.13)**:
- âœ… **ë“€ì–¼ ë·°**: ë‘ ì¹´ë©”ë¼(640x480 ê°ê°)ë¥¼ ë‚˜ë€íˆ ë™ì‹œ í‘œì‹œ
- âœ… **ì‹±ê¸€ ë·°**: ì¹´ë©”ë¼ 0 ë˜ëŠ” ì¹´ë©”ë¼ 1 ì„ íƒ ì‹œ í•´ë‹¹ ì¹´ë©”ë¼ë§Œ í¬ê²Œ í‘œì‹œ
- âœ… **ì‹¤ì‹œê°„ ì „í™˜**: ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ì¦‰ì‹œ ë·° ëª¨ë“œ ì „í™˜
- âœ… **ì¹´ë©”ë¼ ë¼ë²¨**: ëª¨ë“  ë·°ì—ì„œ ì¹´ë©”ë¼ êµ¬ë¶„ ë¼ë²¨ í‘œì‹œ
- âœ… **í•˜íŠ¸ë¹„íŠ¸ ì‹œìŠ¤í…œ**: ë“€ì–¼/ì‹±ê¸€ ëª¨ë“œ ìë™ ê°ì§€ ë° ìƒíƒœ í‘œì‹œ
- âœ… **ê·¸ë¦° í†¤ UI**: ë²„íŠ¼ í˜¸ë²„ ì‹œ ê·¸ë¦° ìƒ‰ìƒìœ¼ë¡œ í†µì¼

**ë°±ì—”ë“œ API í™•ì¥ (2025.09.13)**:
- âœ… **ê°œë³„ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼**: `/stream/0`, `/stream/1` ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
- âœ… **ë“€ì–¼ ëª¨ë“œ API**: `/api/dual_mode/{enable}` í† ê¸€ ê¸°ëŠ¥
- âœ… **ì¹´ë©”ë¼ ì „í™˜ API**: `/switch/{camera_id}` ì‹±ê¸€ ëª¨ë“œ ì „í™˜
- âœ… **ë™ì  ìŠ¤íŠ¸ë¦¼ ê´€ë¦¬**: ë·° ëª¨ë“œì— ë”°ë¥¸ ì¹´ë©”ë¼ ì¸ìŠ¤í„´ìŠ¤ ìë™ ê´€ë¦¬

**í”„ë¡ íŠ¸ì—”ë“œ ì™„ì „ ê°œí¸ (2025.09.13)**:
- âœ… **HTML êµ¬ì¡° ê°œì„ **: ë“€ì–¼/ì‹±ê¸€ ë·° ì»¨í…Œì´ë„ˆ ë¶„ë¦¬
- âœ… **CSS ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ**: 640x480 ê³ ì • í¬ê¸°ë¡œ ìµœì í™”
- âœ… **JavaScript ì•ˆì „ì„±**: null ì°¸ì¡° ë°©ì§€ ë° ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”
- âœ… **ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸**: API ì‘ë‹µ ì „ ì¦‰ì‹œ UI ë³€ê²½ìœ¼ë¡œ ë°˜ì‘ì„± í–¥ìƒ

### ğŸ“… 2025ë…„ 9ì›” 11ì¼ ìµœì‹  ì—…ë°ì´íŠ¸ â­

**ì›¹ UI ê°œì„  (2025.09.11)**:
- âœ… **ì¼ê´€ëœ ë ˆì´ì•„ì›ƒ**: ì¹´ë©”ë¼, í•´ìƒë„, ì‹œìŠ¤í…œ ìƒíƒœ ë²„íŠ¼ ëŒ€ì¹­ ì •ë ¬
- âœ… **ì§ê´€ì  ë””ìì¸**: ëª¨ë“  ì»¨íŠ¸ë¡¤ ìš”ì†Œ ê°€ë¡œ ì •ë ¬ ë° ë™ì¼í•œ ê°„ê²©
- âœ… **ì‹œìŠ¤í…œ ì œì–´ â†’ ì‹œìŠ¤í…œ ìƒíƒœ**: ì¢…ë£Œ ë²„íŠ¼ ìˆ¨ê¹€ ë° ìƒíƒœ ì¤‘ì‹¬ ë””ìì¸
- âœ… **í•˜íŠ¸ë¹„íŠ¸ ë°°ì¹˜**: ë‹¤ë¥¸ ë²„íŠ¼ê³¼ ë™ì¼í•œ í¬ê¸°ì™€ ìŠ¤íƒ€ì¼

**ì‹œìŠ¤í…œ ì•ˆì •ì„± ê°œì„  (2025.09.11)**:
- âœ… **í”„ë ˆì„ ì¹´ìš´í„° ìë™ ë¦¬ì…‹**: 10ë§Œ í”„ë ˆì„ë§ˆë‹¤ ë©”ëª¨ë¦¬ ì•ˆì •ì„±ì„ ìœ„í•œ ìë™ ì´ˆê¸°í™”
- âœ… **Ctrl+C ì¦‰ì‹œ ì¢…ë£Œ**: uvicorn ì‹œê·¸ë„ í•¸ë“¤ë§ ìš°íšŒë¡œ ì¦‰ì‹œ ì¢…ë£Œ
- âœ… **ì¹´ë©”ë¼ ì •ë¦¬ í”„ë¡œì„¸ìŠ¤**: ì¢…ë£Œ ì‹œ ìë™ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ë° ì•ˆì „ ì¢…ë£Œ

**ì›¹/ë°±ì—”ë“œ ë¶„ë¦¬ êµ¬ì¡° (2025.09.11)**:
- âœ… **ë°±ì—”ë“œ ë¡œì§ ë¶„ë¦¬**: `CameraManager` í´ë˜ìŠ¤ë¡œ í•µì‹¬ ì¹´ë©”ë¼ ì œì–´ ë¡œì§ ë…ë¦½
- âœ… **ì›¹ ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬**: `web/` í´ë”ë¡œ HTML/CSS/JS ì™„ì „ ë¶„ë¦¬
- âœ… **API ë¼ìš°í„° ë¶„ë¦¬**: `web/api.py`ë¡œ FastAPI ì—”ë“œí¬ì¸íŠ¸ ëª¨ë“ˆí™”
- âœ… **ì½”ë“œ ë³´í˜¸ ì¤€ë¹„**: í•µì‹¬ ë¡œì§ë§Œ Cython ì»´íŒŒì¼ ê°€ëŠ¥í•œ êµ¬ì¡°

**í˜„ì¬ íŒŒì¼ êµ¬ì¡° (2025.09.13)**:
```
livecam/
â”œâ”€â”€ picam2_webmain.py       # ë“€ì–¼ ë·° ì§€ì› ë¶„ë¦¬ ë²„ì „ â­ ë©”ì¸
â”œâ”€â”€ web/                    # ì›¹ ê´€ë ¨ íŒŒì¼
â”‚   â”œâ”€â”€ static/
â”‚   â”‚   â”œâ”€â”€ index.html      # ë“€ì–¼ ë·° ë©”ì¸ í˜ì´ì§€ (v2.5)
â”‚   â”‚   â”œâ”€â”€ exit.html       # ì¢…ë£Œ í˜ì´ì§€  
â”‚   â”‚   â”œâ”€â”€ style.css       # ë“€ì–¼ ë·° ìŠ¤íƒ€ì¼ì‹œíŠ¸ (v2.4)
â”‚   â”‚   â””â”€â”€ script.js       # ë“€ì–¼ ë·° JavaScript (v2.5)
â”‚   â””â”€â”€ api.py              # ë“€ì–¼ ëª¨ë“œ ì§€ì› FastAPI ë¼ìš°í„°
â””â”€â”€ devdoc.txt              # ê°œì„  ìš”ì²­ì‚¬í•­ ë¬¸ì„œ
```

### ğŸ“… 2025ë…„ 9ì›” 10ì¼ ì¶”ê°€ ê°œì„ ì‚¬í•­

**ë‹¤ì¤‘ í´ë¼ì´ì–¸íŠ¸ ì§€ì› (2025.09.10)**:
- âœ… í•´ìƒë„ë³„ ìµœëŒ€ 2ëª… ë™ì‹œ ì ‘ì† ì§€ì›
- âœ… ì›¹ UIì— ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ í‘œì‹œ (ì˜ˆ: "1/2")
- âœ… ì ‘ì† ì œí•œ ì´ˆê³¼ ì‹œ HTTP 423 ìƒíƒœ ì½”ë“œ ë°˜í™˜

**ì¢…ë£Œ ì²˜ë¦¬ ê°œì„  (2025.09.10)**:
- âœ… Graceful shutdown êµ¬í˜„
- âœ… ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ ë‹¨ìˆœí™” (sys.exit ì‚¬ìš©)
- âœ… uvicorn ì¢…ë£Œ ì‹œ asyncio.CancelledError ì •ìƒ ì²˜ë¦¬

**í•˜íŠ¸ë¹„íŠ¸ ì•ˆì •í™” (2025.09.10)**:
- âœ… HEAD ìš”ì²­ ì œê±°, stats API ê¸°ë°˜ ìƒíƒœ ê°ì§€
- âœ… CSS ë ˆì´ì•„ì›ƒ ê°œì„  (ì ˆëŒ€ ìœ„ì¹˜ ì‚¬ìš©)
- âœ… LIVE/DELAY ê¹œë¹¡ì„ í˜„ìƒ í•´ê²°

### í•µì‹¬ ê¸°ìˆ  êµ¬í˜„

#### 1. ë‹¤ì¤‘ í´ë¼ì´ì–¸íŠ¸ ì œí•œ ì‹œìŠ¤í…œ (2025.09.10 ì—…ë°ì´íŠ¸)
# í•´ìƒë„ë³„ í´ë¼ì´ì–¸íŠ¸ ì œí•œ ì„¤ì •

**ì¥ì **:
- ì•ˆì •ì ì¸ 30fps ìŠ¤íŠ¸ë¦¬ë° ë³´ì¥ (ìµœëŒ€ 2ëª…)
- ë¦¬ì†ŒìŠ¤ ê²½í•© ë°©ì§€
- ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ìµœì í™”
- ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ ëª¨ë‹ˆí„°ë§

#### 2. Picamera2 ê¸°ë°˜ MJPEG ìŠ¤íŠ¸ë¦¬ë° âš¡
**ë¶„ë¦¬ ë²„ì „ (webmain.py)** â­:

**ì„±ëŠ¥ ìµœì í™” ê¸°ë²•** (2025.09.11 ê°œì„ ):
- âœ… **ì§ì ‘ ìº¡ì²˜**: ë²„í¼ë§ ì‹œìŠ¤í…œ ì œê±°ë¡œ ë ˆì´í„´ì‹œ ìµœì†Œí™”
- âœ… **ì‹¤ì‹œê°„ ì²˜ë¦¬**: ìŠ¤ë ˆë“œ ê°„ í†µì‹  ì˜¤ë²„í—¤ë“œ ì œê±°  
- âœ… **ë©”ëª¨ë¦¬ íš¨ìœ¨**: ë¶ˆí•„ìš”í•œ í”„ë ˆì„ ì €ì¥ì†Œ ì œê±°
- âœ… **30fps ë³´ì¥**: ì›ë³¸ê³¼ 100% ë™ì¼í•œ ì„±ëŠ¥ ë‹¬ì„±

#### 3. Picamera2 ì¹´ë©”ë¼ ê´€ë¦¬ ì‹œìŠ¤í…œ âš¡
**Picamera2 ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬** âš¡:
- ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì™„ì „ ì œê±°ë¡œ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì›ì²œ ì°¨ë‹¨
- GPU ë©”ëª¨ë¦¬ ì§ì ‘ ê´€ë¦¬ë¡œ ì•ˆì •ì„± í–¥ìƒ
- Pi5 PiSP (Image Signal Processor) BCM2712_D0 í•˜ë“œì›¨ì–´ ê°€ì†

#### 4. ì‹¤ì‹œê°„ í†µê³„ ì‹œìŠ¤í…œ

### ì›¹ ì¸í„°í˜ì´ìŠ¤ ê¸°ìˆ 

#### í•˜íŠ¸ë¹„íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ â¤ï¸

**UI íŠ¹ì§•** (2025.09 ì—…ê·¸ë ˆì´ë“œ):
- ì „ì²´ í™”ë©´ í™œìš© ì˜ìƒ í‘œì‹œ
- â¤ï¸ **ì‹¤ì‹œê°„ í•˜íŠ¸ë¹„íŠ¸ ì¸ë””ì¼€ì´í„°**: LIVE/DELAY/ERROR/OFFLINE ìƒíƒœ í‘œì‹œ
- ì‹¤ì‹œê°„ í†µê³„ ì—…ë°ì´íŠ¸ (FPS, í”„ë ˆì„ ìˆ˜, ë°ì´í„° í¬ê¸°)
- ì—°ê²° ì œí•œ ìƒíƒœ ìë™ ê°ì§€ ë° í‘œì‹œ
- ì¼ê´€ëœ ë²„íŠ¼ ë””ìì¸ (ì¢…ë£Œ/í•´ìƒë„ ë²„íŠ¼ í†µì¼)

#### CSS ë””ìì¸ ì‹œìŠ¤í…œ
- **ìƒ‰ìƒ íŒ”ë ˆíŠ¸**: ê·¸ë ˆì´ í†¤ + íŒŒë€ìƒ‰ ì•¡ì„¼íŠ¸
- **ë ˆì´ì•„ì›ƒ**: Flexbox ê¸°ë°˜ ë°˜ì‘í˜•
- **ì¸í„°ë™ì…˜**: í˜¸ë²„ íš¨ê³¼ + í™œì„± ìƒíƒœ í‘œì‹œ

### ì„±ëŠ¥ ìµœì í™” ì „ëµ

#### ë©”ëª¨ë¦¬ ê´€ë¦¬ (Picamera2 ìµœì í™”) âš¡
- **GPU ì§ì ‘ ì•¡ì„¸ìŠ¤**: ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ë©”ëª¨ë¦¬ ì˜¤ë²„í—¤ë“œ ì œê±°
- **Zero-copy ìŠ¤íŠ¸ë¦¼**: Picamera2 â†’ BytesIO ì§ì ‘ ì „ì†¡
- **ìë™ ë²„í¼ ê´€ë¦¬**: Pi5 í•˜ë“œì›¨ì–´ ë²„í¼ë§ í™œìš©
- **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€**: ì¸ìŠ¤í„´ìŠ¤ ê¸°ë°˜ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬

#### ë„¤íŠ¸ì›Œí¬ ìµœì í™”
- **HTTP Keep-Alive**: ì—°ê²° ì¬ì‚¬ìš©
- **MJPEG í’ˆì§ˆ**: 80% ì••ì¶• í’ˆì§ˆ
- **í”„ë ˆì„ ë“œë¡­ ë°©ì§€**: ë²„í¼ ì„ê³„ê°’ ê´€ë¦¬

---

## âš« Part 2: ëª¨ì…˜ ê°ì§€ ë¸”ë™ë°•ìŠ¤ ì‹œìŠ¤í…œ

### ì•„í‚¤í…ì²˜ íŒ¨í„´

#### 1. ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš©
```python
# ê° ê¸°ëŠ¥ë³„ ë…ë¦½ í´ë˜ìŠ¤ ì„¤ê³„
â”œâ”€â”€ MotionDetectionSystem      # ë©”ì¸ ì¡°ì •ì
â”œâ”€â”€ CameraStreamManager        # ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì „ë‹´
â”œâ”€â”€ SimpleMotionDetector       # ëª¨ì…˜ ê°ì§€ ì•Œê³ ë¦¬ì¦˜  
â”œâ”€â”€ VideoRecorder             # í”„ë¦¬ë²„í¼ + ë…¹í™” ì‹œìŠ¤í…œ
â”œâ”€â”€ EventManager              # ì´ë²¤íŠ¸ ë¡œê¹…
â””â”€â”€ Config                    # ì„¤ì • ê´€ë¦¬
```

#### 2. í”„ë¦¬ë²„í¼ ì‹œìŠ¤í…œ ì„¤ê³„
```python
class VideoRecorder:
    def __init__(self, pre_buffer=5, post_buffer=25):
        # skip_framesë¥¼ ê³ ë ¤í•œ ì‹¤ì œ fps ê³„ì‚°
        self.actual_buffer_fps = FRAMERATE // SKIP_FRAME  # 30 / 3 = 10fps
        self.frame_buffer = deque(maxlen=pre_buffer * self.actual_buffer_fps)  # 50 í”„ë ˆì„
        
    def add_frame_to_buffer(self, frame):
        # JPEG ì••ì¶•ìœ¼ë¡œ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± í™•ë³´
        _, jpeg_data = cv2.imencode('.jpg', frame, [cv2.IMWRITE_JPEG_QUALITY, 85])
        self.frame_buffer.append(jpeg_data)
```

**í•µì‹¬ ì„¤ê³„ ì›ë¦¬**:
- ë©”ëª¨ë¦¬ íš¨ìœ¨: JPEG ì••ì¶• ì €ì¥
- ì •í™•í•œ ì‹œê°„: í”„ë ˆì„ ë³µì œë¡œ 30fps ë³´ì¥
- ìˆœí™˜ ë²„í¼: ê³ ì • ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

**ì•Œê³ ë¦¬ì¦˜ ìµœì í™”**:
- ë°°ê²½ ì•ˆì •í™”: 60í”„ë ˆì„ í•™ìŠµìœ¼ë¡œ false positive ê°ì†Œ
- ì ì‘í˜• ì—…ë°ì´íŠ¸: ëŠë¦° ë°°ê²½ ë³€í™” ëŒ€ì‘
- í˜•íƒœí•™ì  ì—°ì‚°: ë…¸ì´ì¦ˆ ì œê±°

#### 4. ì˜ìƒ ë³‘í•© ì‹œìŠ¤í…œ
```python
def _merge_video_files(self, input_files, output_file):
    merge_cmd = [
        "ffmpeg",
        "-f", "concat", "-safe", "0", "-i", str(list_file),
        "-c:v", "libx264",      # H.264 ì½”ë±
        "-preset", "fast",      # ì¸ì½”ë”© ì†ë„ í–¥ìƒ
        "-t", "30",            # ì •í™•íˆ 30ì´ˆ
        "-r", "30",            # 30fps í†µì¼
        "-pix_fmt", "yuv420p", # í˜¸í™˜ì„± í–¥ìƒ
        "-y", str(output_file)
    ]
```

**í’ˆì§ˆ ë³´ì¥ ë©”ì»¤ë‹ˆì¦˜**:
- Duration ê²€ì¦: ffprobeë¡œ ì‹¤ì œ ê¸¸ì´ í™•ì¸
- í”„ë ˆì„ë ˆì´íŠ¸ í†µì¼: ëª¨ë“  êµ¬ê°„ 30fps
- ì—ëŸ¬ ë³µêµ¬: 60ì´ˆ íƒ€ì„ì•„ì›ƒ + ì¬ì‹œë„

### ê³ ê¸‰ ê¸°ëŠ¥ êµ¬í˜„

#### 1. ë‚ ì§œë³„ ìë™ ë¶„ë¥˜

#### 2. ìŠ¤ë ˆë“œ ì•ˆì „ì„±

## ê°œë°œ ë„êµ¬ ë° ë””ë²„ê¹…

### ë¡œê¹… ì‹œìŠ¤í…œ

#### CCTV ì‹œìŠ¤í…œ ë¡œê·¸

### ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

#### ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰

#### ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
| ì‹œìŠ¤í…œ | CPU ì‚¬ìš©ë¥  | ë©”ëª¨ë¦¬ | ë””ìŠ¤í¬ I/O | ë¹„ê³  |
|--------|------------|--------|------------|------|
| **CCTV (480p)** | ~7% | 40MB | 1-2MB/s | ë“€ì–¼ ë·° |
| **CCTV (720p)** | ~11% | 50MB | 3-4MB/s | ë“€ì–¼ ë·° |
| **ë…¹í™” (720p)** | ~8-10% | 30-40MB | 6-8MB/30s | ì¹´ë©”ë¼ë‹¹ |
| **ì „ì²´ ì‹œìŠ¤í…œ** | ~25-30% | 120MB | - | ëª¨ë“  ê¸°ëŠ¥ |

### ë¬¸ì œ í•´ê²° ê°€ì´ë“œ

#### 1. CCTV ìŠ¤íŠ¸ë¦¬ë° ë¬¸ì œ
```bash
# ì¹´ë©”ë¼ í•˜ë“œì›¨ì–´ í™•ì¸
rpicam-hello --list-cameras
rpicam-hello --camera 0 --timeout 2000

# Picamera2 ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
python3 -c "from picamera2 import Picamera2; print('Picamera2 OK')"

# ê¶Œí•œ ë¬¸ì œ í•´ê²°
sudo usermod -a -G video $USER

# GPU ë©”ëª¨ë¦¬ í™•ì¸
vcgencmd get_mem gpu
```

#### 2. ë…¹í™” ë¬¸ì œ
```bash
# ì¹´ë©”ë¼ ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
ps aux | grep rpicam

# ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
df -h /home/shinho

# íŒŒì¼ ê¶Œí•œ í™•ì¸
ls -la videos/cam_rec/
```

#### 3. ë“€ì–¼ ì¹´ë©”ë¼ ì¶©ëŒ
```bash
# ISP ë¦¬ì†ŒìŠ¤ í™•ì¸
dmesg | grep -i pisp

# ì¹´ë©”ë¼ ë¦¬ìŠ¤íŠ¸ í™•ì¸
rpicam-hello --list-cameras
```

#### 4. ë©”ëª¨ë¦¬ ë¶€ì¡± ë¬¸ì œ
```bash
# GPU ë©”ëª¨ë¦¬ ì¦ê°€
sudo raspi-config
# Advanced Options â†’ Memory Split â†’ 256

# ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ í™•ì¸
free -h
```

---

## ë°°í¬ ë° ìš´ì˜

### systemd ì„œë¹„ìŠ¤ ì„¤ì •
```bash
# /etc/systemd/system/cctv.service
[Unit]
Description=CCTV Streaming System
After=multi-user.target

[Service]
Type=simple
User=shinho
WorkingDirectory=/home/shinho/shinho/livecam1
ExecStart=/usr/bin/python3 webmain.py
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
# /etc/systemd/system/recording.service
[Unit]
Description=Camera Recording System
After=multi-user.target

[Service]
Type=simple
User=shinho
WorkingDirectory=/home/shinho/shinho/livecam1
ExecStart=/bin/bash -c "python3 rec_cam0.py & python3 rec_cam1.py"
Restart=always

[Install]
WantedBy=multi-user.target
```

## í–¥í›„ ê°œë°œ ê³„íš

### ë‹¨ê¸° ê°œì„ ì‚¬í•­
- ëª¨ë°”ì¼ ë°˜ì‘í˜• UI ê°œì„ 
- ì˜ìƒ ì¸ë„¤ì¼ ìƒì„±
- ë””ìŠ¤í¬ ê³µê°„ ìë™ ê´€ë¦¬

### ì¤‘ê¸° ê°œë°œ
- ëª¨ì…˜ ê°ì§€ ê¸°ë°˜ ì´ë²¤íŠ¸ ë…¹í™”
- í´ë¼ìš°ë“œ ë°±ì—… ì—°ë™
- REST API í™•ì¥

### ì¥ê¸° ë¹„ì „
- AI ê¸°ë°˜ ê°ì²´ ê°ì§€
- ë‹¤ì¤‘ ë¼ì¦ˆë² ë¦¬íŒŒì´ í´ëŸ¬ìŠ¤í„°
- ì¤‘ì•™ ê´€ì œ ì‹œìŠ¤í…œ

---

## ì°¸ê³  ìë£Œ ë° ì˜ì¡´ì„±

### ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬
```python
# requirements.txt
fastapi>=0.104.0
uvicorn>=0.24.0
picamera2>=0.3.12
opencv-python>=4.8.0
numpy>=1.24.0
pillow>=10.0.0
psutil>=5.9.0
```

### ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€
```bash
# ê¸°ë³¸ íŒ¨í‚¤ì§€
sudo apt install -y rpicam-apps ffmpeg python3-opencv

# Picamera2 ê´€ë ¨ íŒ¨í‚¤ì§€
sudo apt install -y python3-picamera2 python3-libcamera

# GPU ë©”ëª¨ë¦¬ ì„¤ì • (ê¶Œì¥: 256MB)
sudo raspi-config  # Advanced Options â†’ Memory Split â†’ 256
```

### ì°¸ê³  ë¬¸ì„œ
- [Raspberry Pi Camera Documentation](https://www.raspberrypi.com/documentation/computers/camera_software.html)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [OpenCV Python Tutorials](https://docs.opencv.org/4.x/d6/d00/tutorial_py_root.html)
- [ffmpeg Documentation](https://ffmpeg.org/documentation.html)

### ì½”ë”© ì»¨ë²¤ì…˜
- **Python**: PEP 8 ì¤€ìˆ˜
- **í•¨ìˆ˜ëª…**: snake_case
- **í´ë˜ìŠ¤ëª…**: PascalCase
- **ìƒìˆ˜**: UPPER_CASE
- **ì£¼ì„**: í•œêµ­ì–´ + ì˜ì–´ í˜¼ìš©

### Git ì›Œí¬í”Œë¡œìš°
```bash
# ê¸°ëŠ¥ ë¸Œëœì¹˜
git checkout -b feature/new-detection-algorithm
git commit -m "feat: implement advanced motion detection"
git push origin feature/new-detection-algorithm
```

---

## ê¸°ì—¬ ê°€ì´ë“œ

### ì½”ë“œ ê¸°ì—¬
1. ì´ìŠˆ ìƒì„± ë° ë…¼ì˜
2. ê¸°ëŠ¥ ë¸Œëœì¹˜ ìƒì„±
3. ì½”ë“œ ì‘ì„± ë° í…ŒìŠ¤íŠ¸
4. ë¬¸ì„œ ì—…ë°ì´íŠ¸
5. Pull Request ìƒì„±

### ë¬¸ì„œ ê¸°ì—¬
- **PRD.md**: ì œí’ˆ ìš”êµ¬ì‚¬í•­ ë° ì•„í‚¤í…ì²˜
- **README.md**: ì‚¬ìš©ì ê°€ì´ë“œ ë° ì„¤ì¹˜ ë°©ë²•
- **CLAUDE.md**: ê°œë°œì ê¸°ìˆ  ë¬¸ì„œ (í˜„ì¬ íŒŒì¼)

### í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ
```bash
# CCTV ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
curl -I http://localhost:8001/stream  # ìŠ¤íŠ¸ë¦¼ ì‘ë‹µ í™•ì¸
curl http://localhost:8001/api/stats  # í†µê³„ API í…ŒìŠ¤íŠ¸

# ë…¹í™” ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
ls -la videos/cam_rec/cam0/           # ë…¹í™” íŒŒì¼ í™•ì¸
ffprobe videos/cam_rec/cam0/*.mp4     # ì˜ìƒ ì •ë³´ í™•ì¸

# GPU ê°€ì† í™•ì¸
dmesg | grep -i pisp                   # PiSP í•˜ë“œì›¨ì–´ ê°€ì† ë¡œê·¸
```